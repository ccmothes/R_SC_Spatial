---
title: Intermediate Spatial Analysis in R - Monthly Summaries
author: carverd@colostate.edu 
output:
  html_document:
  code_folding: hide
highlight: tango
theme: yeti
toc: no
toc_depth: 4
toc_float:
  collapsed: yes
smooth_scroll: yes
---

 
### Assessment of `r county`

```{r echo=FALSE, message=FALSE, warning=F}
# use pacman to load require packages 
if (!require("pacman")) install.packages("pacman") ## important because we will be calling this script mulitple times 
pacman::p_load(dplyr,raster,tmap,plotly)
# set number of sigfigs 
options(scipen=999)
# set tmap to interactive viewing 
tmap::tmap_mode("view")

baseDir <- "F:/geoSpatialCentroid/softwareCarpentry/intermediateGeospatialR"
county <- "Bexar"
months <- c("april", "may", "june", "july")
filters <- c(2,6,10)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

### grab imagery for county 
images <- list.files(paste0(baseDir,"/data/nightLights/", county), pattern = ".tif", full.names = TRUE)
counts <- list.files(paste0(baseDir,"/data/nightLights/"), pattern = "_counts.tif", full.names = TRUE)

# loop over months 
for(i in seq_along(months)){
  # select rasters using character match 
  m <- months[i]
  r1 <- raster::raster(images[grepl(pattern = m, x = images)]) 
  r1[r1 == 0] <- NA
  # create a mask 
  mask <- r1 
  mask[!is.na(mask)] <- 1
  # look at the number of values left
  # t3 <- length(values(r1)[!is.na(values(r1))])

  c1 <- raster::raster(counts[grepl(pattern = m, x = counts)])*mask 
  #df to store results 
  df1 <- data.frame(matrix(nrow = 3, ncol = 2+length(filters)))
  colnames(df1) <- c("month","measure", as.character(filters)) 
  df1$month <- m
  df1$measure <- c("mean", "median", "count")
    ## loop over all seq 
    for(j in seq_along(filters)){
      # generate a mask with the counts image based on the seq value 
      c2 <- c1 
      # replace all values based on filter val
      c2[c2 < filters[j], ] <- NA 
      # generate a mask base on new filtered data 
      c2[!is.na(c2), ]<- 1 
      # apply that mask to radaince value 
      r2 <- r1 * c2 
      # calculate Mean, median of masked radiance raster 
      vals <- raster::values(r2)
      # drop all na values 
      vals <- vals[!is.na(vals)]
      df1[1,j+2] <- mean(vals)
      df1[2,j+2] <- median(vals)
      # count total obervationa in mask. 
      df1[3,j+2] <- length(vals) 
    }
  if(i == 1){
    df <- df1
  }else{
    df <- dplyr::bind_rows(df, df1)
  }
}

```

## Map of radiance values for most complete month 

Area in red shows the extent of the county. 
The area in the blue to yellow gradient shows the unfiltered observations. 

Filtering at this point was performed by the working established at the School of Mines. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
### map of the image location with the most observations 
m1 <- df %>%
  dplyr::filter(measure == "count")%>%
  dplyr::arrange(desc(`10`))%>%
  dplyr::select(month)
# most obsevations 
r1 <- raster::raster(images[grepl(pattern = m1$month[1], x = images)]) 
r2 <- r1 
r2[r2==0,] <- NA

tm_shape(r1)+
  tm_raster(breaks = c(0,max(raster::values(r1),na.rm = TRUE)), showNA = FALSE,
            palette = "-Set1", title = "extent of county")+
tmap::tm_shape(r2)+
  tm_raster(palette = "-YlGnBu", style = "cont", title = m)
```

## Map of number of observations for each mean radiance 

Number of observations used to determine the monthly mean value at a given location

```{r echo=FALSE, message=FALSE, warning=FALSE}
### map of the number of observations at a location 
c1 <- raster::raster(counts[grepl(pattern = m, x = counts)]) *mask
max <- max(unique(values(c1)), na.rm = TRUE)
if(max %% 2){
  b1 <- seq(from = 0, to = max, 2)  
}else{
  b1 <- seq(from = 0, to = max+1, 2)  
}


tmap::tm_shape(c1)+
  tm_raster(breaks = b1, 
            title = m)

```

## Relationship between number of observations and county level statistics 

Plot 1 : The trend of county level mean when filtered based on the number of observations at a location 


Plot 2 : The trend of county level median when filtered based on the number of observations at a location 


Plot 3 : The percent of the counties total area present when filtered based on the number of observations at a location 

```{r echo=FALSE, message=FALSE, warning=FALSE}
### genrate the plot 
# present a graph of the average values (mean and median) across the county with all measures and increasingly highly levels of filtering. 

df2 <- df[df$measure != "test2", ]
# create empty dataframe 
df3 <- data.frame(matrix(nrow = length(filters) * length(unique(df2$month)), ncol = 5))
colnames(df3) <- c("month","filter", "mean", "median", "counts")
df3$month <- factor(rep(unique(df2$month), each = length(filters)), 
                       levels = c(unique(df2$month)))
df3$filter <- rep(unique(filters), length(unique(df3$month)))
mean <- c()
median <- c()
count <- c()
for(i in seq_along(unique(df2$month))){
  df2a <- df2[df2$month == unique(df3$month)[i], ]
  mean <- c(mean, as.numeric(df2a[df2a$measure== "mean", 3:ncol(df3)]))
  median <- c(median, as.numeric(df2a[df2a$measure== "median", 3:ncol(df3)]))
  count <- c(count, as.numeric(df2a[df2a$measure== "count", 3:ncol(df3)]))
}
df3$mean <- mean
df3$median <- median
df3$counts <- count

### seperate the values 
library(plotly)
p1 <- plot_ly(mode = "lines+markers", sort = FALSE ) %>%
  add_trace(x=df3$filter, y=df3$mean,type = 'scatter', color = df3$month, line = list(dash = 'dash', shape= "spline"))%>%
  layout(xaxis = list(title = "Number of Observations "),
            yaxis = list(title = "Mean"))

p2 <- plot_ly(mode = "lines+markers" ) %>%
  add_trace(x=df3$filter, y=df3$median,type = 'scatter', color = df3$month, line = list(dash = 'solid', shape= "spline"), showlegend = FALSE) %>%
  layout(xaxis = list(title = "Number of Observations "),
         yaxis = list(title = "Median"))

p3 <- plot_ly(mode = "lines+markers" ) %>%
  add_trace(x=df3$filter, y=df3$counts,type = 'scatter', color = df3$month, line = list(dash = 'dashdot', shape= "spline"), showlegend = FALSE) %>%
  layout(xaxis = list(title = "Number of Observations "),
         yaxis = list(title = "% Observations"))

p<- plotly::subplot(p1,p2,p3, nrows = 3, shareX = TRUE, titleY = TRUE)
p 

```

### Example: least well represented month 

Red: full extent of the county 

Blue - yellow: Radience values in  the county with at least six observations.  

```{r echo=FALSE, message=FALSE, warning=FALSE}
### map of the image location
# select the last month in the list 
m <- as.character(m1$month[nrow(m1)])
r1 <- raster::raster(images[grepl(pattern = m, x = images)]) 
c1 <- raster::raster(counts[grepl(pattern = m, x = counts)])
# define filter level from last column name
f1 <- colnames(df)[ncol(df)]

c1[c1 < as.numeric(f1)] <- NA
r2 <- r1 * c1 * mask
tm_shape(r1)+
  tm_raster(breaks = c(0,max(raster::values(r1),na.rm = TRUE)), showNA = FALSE,
            palette = "-Set1", title = "extent of county")+
tm_shape(r2)+
  tm_raster(palette = "-YlGnBu", style = "cont", title = paste0(m, " 6 plus observations"))
```

